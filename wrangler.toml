name = "wrldone"
main = "dist/_worker.js"
compatibility_date = "2024-11-01"
compatibility_flags = ["nodejs_compat"]

# WRLD Inc. Cloudflare Account
account_id = "1260edafa2dec8e0bdf243859e07c160"

# =============================================================================
# Environment Configuration
# =============================================================================

# Default environment (for `wrangler dev` and `wrangler deploy`)
# Deploys to wrldone.wrld-inc.workers.dev for quick testing
workers_dev = true

[env.production]
name = "wrldone"
route = { pattern = "wrld.one/*", zone_name = "wrld.one" }
workers_dev = false

[env.staging]
name = "wrldone-staging"
# Staging available at wrldone-staging.wrldtech.workers.dev
workers_dev = true

[env.staging.vars]
ENVIRONMENT = "staging"
PUBLIC_TYPESENSE_HOST = "localhost"
PUBLIC_TYPESENSE_PORT = "8108"
PUBLIC_TYPESENSE_PROTOCOL = "https"

# =============================================================================
# Assets Configuration
# =============================================================================

[assets]
directory = "./dist"

# =============================================================================
# Public Environment Variables
# =============================================================================

[vars]
ENVIRONMENT = "production"
# Typesense configuration (non-sensitive)
PUBLIC_TYPESENSE_HOST = "localhost"
PUBLIC_TYPESENSE_PORT = "8108"
PUBLIC_TYPESENSE_PROTOCOL = "https"

# =============================================================================
# KV Namespace Bindings
# =============================================================================

# Search cache - cache search results at the edge
# Uncomment after creating: wrangler kv:namespace create "SEARCH_CACHE"
# [[kv_namespaces]]
# binding = "SEARCH_CACHE"
# id = "<your-kv-namespace-id>"

# Rate limiting - distributed rate limiting across edge locations
# Uncomment after creating: wrangler kv:namespace create "RATE_LIMIT"
# [[kv_namespaces]]
# binding = "RATE_LIMIT"
# id = "<your-kv-namespace-id>"

# =============================================================================
# Analytics Engine Binding (Real-time analytics & dashboards)
# =============================================================================

# Uncomment after creating Analytics Engine dataset:
# wrangler analytics-engine create wrldone-analytics

# [[analytics_engine_datasets]]
# binding = "ANALYTICS"
# dataset = "wrldone_analytics"

# =============================================================================
# Pipelines Binding (Event streaming to R2 data lake)
# Use for: Long-term storage, data warehouse, batch analytics
# =============================================================================

# Pipeline streams events to R2 as Iceberg tables / Parquet / JSON
# Data can be queried with tools like DuckDB, Spark, Trino

[[pipelines]]
pipeline = "4a92cc481b0c4dbeb93ec60092dc4543"
binding = "EVENTS"

# =============================================================================
# Rate Limiting (via Workers)
# Protect API endpoints from abuse
# =============================================================================

# Rate limiting is implemented in code using the KV namespace
# See src/pages/api/search.ts for implementation

# =============================================================================
# Smart Placement
# Automatically place Worker near backend services
# =============================================================================

[placement]
mode = "smart"

# =============================================================================
# Caching Configuration
# =============================================================================

# Browser caching rules for static assets
# Configure in Cloudflare dashboard under Caching > Configuration

# =============================================================================
# Observability Configuration
# =============================================================================

[observability]
enabled = true
head_sampling_rate = 1

[observability.logs]
enabled = true
head_sampling_rate = 1
persist = true
invocation_logs = true

[observability.traces]
enabled = true
persist = true
head_sampling_rate = 1

# =============================================================================
# Build Configuration
# =============================================================================

[build]
command = "npm run build"

# =============================================================================
# Limits (Enterprise only)
# =============================================================================

# [limits]
# cpu_ms = 50
